using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Mvc;
using System.Data.Entity;

namespace nhom6.Frontend
{
    public class ProductController : Controller
    {
        private nhom6Entities db = new nhom6Entities();
        // GET: Product
        public ActionResult Index()
        {
            return View();
        }

        public ActionResult Shop()
        {
            var listProduct = db.Products.ToList();
            return View(listProduct);
        }
        public ActionResult ProductDetails(int? id)
        {
            if (id == null)
            {
                return HttpNotFound();
            }

            // Truy vấn sản phẩm theo id
            var product = db.Products.SingleOrDefault(p => p.ProductID == id);
            if (product == null)
            {
                return HttpNotFound();
            }

            // Truy vấn danh sách ảnh của sản phẩm
            var productImages = db.ProductImages.Where(pi => pi.ProductID == id).ToList();
            ViewBag.ProductImages = productImages;

            // Truy vấn danh sách size của sản phẩm
            var sizes = db.Instocks
                          .Where(i => i.ProductID == id)
                          .Select(i => i.Size)
                          .Distinct()
                          .ToList();
            ViewBag.Sizes = sizes;

            // Truy vấn danh mục của sản phẩm
            var category = db.Categories.SingleOrDefault(c => c.categoryID == product.CategoryID);
            ViewBag.CategoryName = category?.categoryName;

            // Truy vấn danh sách ảnh của sản phẩm từ bảng ColorImage
            var colorImages = db.ColorImages
                .Where(ci => ci.ProductID == id)
                .GroupBy(ci => ci.ColorID) // Nhóm ảnh theo ColorID
                .ToDictionary(g => g.Key, g => g.ToList()); // Chuyển thành Dictionary để dễ truy cập

            ViewBag.ColorImages = colorImages;

            // Truy vấn danh sách màu sắc của sản phẩm
            var colors = db.ColorImages
                .Where(ci => ci.ProductID == id)
                .Select(ci => ci.Color)
                .Distinct()
                .ToList();
            ViewBag.Colors = colors;

            // Mặc định chọn ColorID đầu tiên
            var firstColor = colors.FirstOrDefault();
            int firstColorId = firstColor?.ColorID ?? 0; // Sử dụng toán tử null-coalescing để gán giá trị mặc định nếu firstColor là null
            ViewBag.SelectedColorId = firstColorId;

            // Lấy danh sách ảnh của ColorID đầu tiên
            var defaultImages = colorImages.ContainsKey(firstColorId) ? colorImages[firstColorId] : new List<ColorImage>();
            ViewBag.DefaultImages = defaultImages;

            // Debug: Kiểm tra dữ liệu
            System.Diagnostics.Debug.WriteLine($"Số lượng ảnh: {defaultImages.Count}");

            // Trả về view với sản phẩm
            return View(product);
        }
        public ActionResult GetColorImages(int colorId)
    {
        var colorImages = db.ColorImages
            .Where(ci => ci.ColorID == colorId)
            .Select(ci => new { ci.Image })
            .ToList();

        return Json(colorImages, JsonRequestBehavior.AllowGet);
    }
    }
}









@model nhom6.Product

@{
    ViewBag.Title = "ProductDetails";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@{
    var productImages = ViewBag.ProductImages as List<nhom6.ProductImage>;
    if (productImages == null || !productImages.Any())
    {
        <p>Không có ảnh nào cho sản phẩm này.</p>
    }
}

    <section class="shop-details">
        <div class="product__details__pic">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="product__details__breadcrumb">
                            <a href="./index.html">Home</a>
                            <a href="./shop.html">Shop</a>
                            <span>Product Details</span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-3 col-md-3">
                        <ul class="nav nav-tabs" role="tablist" id="color-thumbnails">
                            @{
                                var defaultImages = ViewBag.DefaultImages as List<nhom6.ColorImage>;
                                if (defaultImages != null && defaultImages.Any())
                                {
                                    for (int i = 0; i < defaultImages.Count; i++)
                                    {
                                        <li class="nav-item">
                                            <a class="nav-link @(i == 0 ? "active" : "")" data-toggle="tab" href="#tabs-@(i + 1)" role="tab">
                                                <div class="product__thumb__pic set-bg" data-setbg="@Url.Content("~/Content/Image/Product1/" + defaultImages[i].Image)">
                                                </div>
                                            </a>
                                        </li>
                                    }
                                }
                            }
                        </ul>
                    </div>
                    <div class="col-lg-6 col-md-9">
                        <div class="tab-content" id="color-images">
                            @if (defaultImages != null && defaultImages.Any())
                            {
                                for (int i = 0; i < defaultImages.Count; i++)
                                {
                                    <div class="tab-pane @(i == 0 ? "active" : "")" id="tabs-@(i + 1)" role="tabpanel">
                                        <div class="product__details__pic__item">
                                            <img src="@Url.Content("~/Content/Image/Product1/" + defaultImages[i].Image)" alt="">
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <p>Không có ảnh nào để hiển thị.</p>
                            }
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <div class="product__details__content">
            <div class="container">
                <div class="row d-flex justify-content-center">
                    <div class="col-lg-8">
                        <div class="product__details__text">
                            <h4>@Model.ProductName</h4>
                            <h3>@Model.UnitPrice</h3>

                            <div class="product__details__option">
                                <div class="product__details__option__size">
                                    <span>Size:</span>
                                    @{
                                        var sizes = ViewBag.Sizes as List<nhom6.Size>;
                                        if (sizes != null && sizes.Any())
                                        {
                                            foreach (var size in sizes)
                                            {
                                                <label for="@size.SizeName">
                                                    @size.SizeName
                                                    <input type="radio" id="@size.SizeName" name="size" value="@size.SizeID">
                                                </label>
                                            }
                                        }
                                    }
                                </div>

                                <div class="product__details__option__color">
                                    <span>Color:</span>
                                    @foreach (var color in ViewBag.Colors)
                                    {
                                        <label for="color-@color.ColorID" style="background-color: @color.ColorCode;" onclick="updateColorImages(@color.ColorID)">
                                            <input type="radio" id="color-@color.ColorID" name="color" value="@color.ColorID"
                                                   data-color-id="@color.ColorID">
                                            <span class="color-swatch"></span>
                                        </label>
                                    }
                                </div>

                            </div>

                            <div class="product__details__cart__option">
                                <div class="quantity">
                                    <div class="pro-qty">
                                        <input type="text" value="1">
                                    </div>
                                </div>
                                <a href="#" class="primary-btn">add to cart</a>
                            </div>

                            <div class="product__details__last__option">
                                <img src="img/shop-details/details-payment.png" alt="">
                                <ul>
                                    <li><span>Categories:</span> @ViewBag.CategoryName</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-12">
                        <div class="product__details__tab">
                            <ul class="nav nav-tabs" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" data-toggle="tab" href="#tabs-5"
                                       role="tab">Mô tả</a>
                                </li>
                            </ul>
                            <div class="tab-content">
                                <div class="tab-pane active" id="tabs-5" role="tabpanel">
                                    <div class="product__details__tab__content">
                                        <p class="note">
                                            @Model.UnitDescription
                                        </p>
                                    </div>
                                </div>



                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    @section scripts {
        <script>
            $(document).ready(function () {
                $('.set-bg').each(function () {
                    var bg = $(this).data('setbg');
                    $(this).css('background-image', 'url(' + bg + ')');
                });
            });
        function updateColorImages(colorId) {        
    // Gửi yêu cầu AJAX để lấy danh sách ảnh của ColorID được chọn
    $.ajax({
        url: '@Url.Action("GetColorImages", "Product")', // Đường dẫn đến action trong controller
        type: 'GET',
        data: { colorId: colorId },
        success: function (response) {
            // Cập nhật danh sách ảnh trong phần thumbnails
            var thumbnailsHtml = '';
            var imagesHtml = '';

         for (var i = 0; i < response.length; i++) {
            var imageUrl = '@Url.Content("~/Content/Image/Product1/")' + response[i].Image;
            thumbnailsHtml += `
                <li class="nav-item">
                    <a class="nav-link ${i === 0 ? 'active' : ''}" data-toggle="tab" href="#tabs-${i + 1}" role="tab">
                        <div class="product__thumb__pic set-bg" style="background-image: url('${imageUrl}');"></div>
                    </a>
                </li>
            `;

            imagesHtml += `
                <div class="tab-pane ${i === 0 ? 'active' : ''}" id="tabs-${i + 1}" role="tabpanel">
                    <div class="product__details__pic__item">
                        <img src="${imageUrl}" alt="">
                    </div>
                </div>
            `;
        }

            // Cập nhật HTML
            $('#color-thumbnails').html(thumbnailsHtml);
            $('#color-images').html(imagesHtml);
        },
        error: function () {
            alert('Có lỗi xảy ra khi tải ảnh.');
        }
    });
}

        </script>
    }